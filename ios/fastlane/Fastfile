default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Setup keychain and other CI-specific stuff
    setup_ci if ENV["CI"]

    # Generates ios/Flutter/Generated.xcconfig, required by the Podfile
    sh("cd .. && flutter pub get")

    # Make sure CocoaPods is setup correcly
    cocoapods(
      clean: true,
      podfile: "./Podfile"
    )

    app_store_connect_api_key(
      key_id: ENV["APPSTORE_CONNECT_API_ISSUER_ID"],
      issuer_id: ENV["APPSTORE_CONNECT_API_KEY_ID"],
      key_content: ENV["APPSTORE_CONNECT_API_KEY_CONTENT"],
      in_house: false,
      duration: 1200,
      is_key_content_base64: true,
    )

    # Sync code signing
    match(type: "appstore")
  
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      clean: true,
      export_method: "app-store",
      export_options: {
        provisioningProfiles: { 
          "se.agardh.musbox" => "match AppStore se.agardh.musbox"
        },
        signingStyle: "manual",
      }
    )
    
    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
end