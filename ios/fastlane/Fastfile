default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Setup keychain and other CI-specific stuff
    setup_ci if ENV["CI"]

    # Generates ios/Flutter/Generated.xcconfig, required by the Podfile
    sh("cd .. && flutter pub get")

    # Make sure CocoaPods is setup correcly
    cocoapods(
      clean: true,
      podfile: "./Podfile"
    )

    # Generate AppStore Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["APPSTORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APPSTORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APPSTORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
      duration: 500,
      in_house: false,
    )

    # Sync code signing
    match(
      type: "appstore",
      api_key: api_key,
    )
  
    # Build
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      clean: true,
      export_method: "app-store",
      export_options: {
        provisioningProfiles: { 
          "se.agardh.musbox" => "match AppStore se.agardh.musbox"
        },
        signingStyle: "manual",
      }
    )
    
    # Upload
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
    )
  end
end